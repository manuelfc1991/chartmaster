/**
 * ChartMaster.js - Optimized Complete Charting Library
 * Enhanced with Funnel and Gauge charts
 * @version 3.0.0
 * @license MIT
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).ChartMaster=t()}(this,function(){"use strict";class e{constructor(e,t){if(this.canvas=document.getElementById(e),!this.canvas)throw new Error(`Canvas "${e}" not found`);this.ctx=this.canvas.getContext("2d",{alpha:!1}),this.width=this.canvas.width,this.height=this.canvas.height,this.type=t.type||"line",this.data=t.data||{},this.options=this.mergeOptions(t.options||{}),this.animationProgress=0,this.isAnimating=!1,this.hoveredIndex=-1,this.tooltipData=null,this.chartArea=null,this.scales={x:null,y:null},this.detailedView=!1,this.titleHeight=0,this.legendHeight=0,this.axisHeight=0,this.axisWidth=0,this.cache=new Map,this.frameId=null,this.boundHandlers={},this.touchStartTime=0,this.touchStartX=0,this.touchStartY=0,this.backgroundColor=t.backgroundColor||"#ffffff",this.setupStyles(),this.setupEventListeners(),this.render()}setupStyles(){if(!document.getElementById("chartmaster-styles")){const e=document.createElement("style");e.id="chartmaster-styles",e.textContent=`      .chartmaster-tooltip {        position: fixed;        background: rgba(0, 0, 0, 0.9);        color: white;        padding: 10px 14px;        border-radius: 8px;        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;        font-size: 13px;        pointer-events: none;        z-index: 10000;        box-shadow: 0 4px 12px rgba(0,0,0,0.4);        backdrop-filter: blur(8px);        border: 1px solid rgba(255,255,255,0.15);        white-space: nowrap;        max-width: 250px;        opacity: 0;        transition: opacity 0.15s ease;      }      .chartmaster-tooltip.visible {        opacity: 1;      }      .chartmaster-tooltip::after {        content: '';        position: absolute;        top: 100%;        left: 50%;        transform: translateX(-50%);        border: 6px solid transparent;        border-top-color: rgba(0, 0, 0, 0.9);      }      .chartmaster-tooltip strong {        display: block;        margin-bottom: 4px;        font-size: 14px;      }      .chartmaster-detailed-view {        position: fixed;        background: white;        border: 1px solid #ddd;        border-radius: 12px;        padding: 20px;        box-shadow: 0 8px 24px rgba(0,0,0,0.12);        z-index: 10001;        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;        max-width: 320px;        min-width: 280px;        animation: chartmaster-slideIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);      }      .chartmaster-detailed-view h4 {        margin: 0 0 12px 0;        color: #1a1a1a;        font-size: 16px;        font-weight: 600;        border-bottom: 2px solid #f0f0f0;        padding-bottom: 8px;      }      .chartmaster-detailed-view p {        margin: 6px 0;        color: #666;        font-size: 13px;      }      .chartmaster-detailed-view .data-point {        display: flex;        justify-content: space-between;        align-items: center;        margin: 10px 0;        padding: 8px 0;        border-bottom: 1px solid #f5f5f5;      }      .chartmaster-detailed-view .data-point:last-child {        border-bottom: none;      }      .chartmaster-detailed-view .data-point span:first-child {        color: #666;        font-size: 12px;      }      .chartmaster-detailed-view .data-point span:last-child {        font-weight: 600;        color: #333;      }      .chartmaster-detailed-view .color-indicator {        width: 14px;        height: 14px;        border-radius: 3px;        display: inline-block;        margin-right: 8px;        vertical-align: middle;        box-shadow: 0 1px 3px rgba(0,0,0,0.2);      }      .chartmaster-detailed-view .section-divider {        margin: 16px 0;        padding-top: 16px;        border-top: 2px solid #e8e8e8;      }      @keyframes chartmaster-slideIn {        from {           opacity: 0;           transform: scale(0.95) translateY(-10px);         }        to {           opacity: 1;           transform: scale(1) translateY(0);         }      }    `,document.head.appendChild(e)}}mergeOptions(e){const t={responsive:!0,maintainAspectRatio:!0,backgroundColor:"#ffffff",detailedView:{enabled:!0,trigger:"doubleClick",showStats:!0,showRawData:!1},animation:{duration:800,easing:"easeOutQuart"},plugins:{legend:{display:!0,position:"top",align:"center",labels:{color:"#666",font:{size:12,family:"Arial"},padding:12,boxWidth:12,usePointStyle:!1},padding:15},title:{display:!1,text:"",color:"#333",font:{size:16,weight:"bold",family:"Arial"},padding:{top:10,bottom:15},align:"center"},tooltip:{enabled:!0,mode:"nearest"}},scales:{x:{display:!0,title:{display:!1,text:"",color:"#666",font:{size:12,family:"Arial"}},grid:{display:!0,color:"rgba(0, 0, 0, 0.08)"},ticks:{padding:8,maxRotation:0}},y:{display:!0,beginAtZero:!0,title:{display:!1,text:"",color:"#666",font:{size:12,family:"Arial"}},grid:{display:!0,color:"rgba(0, 0, 0, 0.08)"},ticks:{padding:8}}},layout:{padding:{top:20,right:20,bottom:20,left:20},autoPadding:!0},elements:{line:{borderWidth:2,tension:.4,fill:!1},point:{radius:3,hoverRadius:5,hitRadius:10},bar:{borderWidth:0,borderRadius:4},arc:{borderWidth:2,borderColor:"#fff",hoverOffset:10}},funnel:{width:.7,gap:.02,sort:"desc"},gauge:{startAngle:-135,endAngle:135,thickness:.2,showValue:!0,valueFormat:e=>e.toFixed(1),ranges:[{min:0,max:33,color:"#ef4444"},{min:33,max:66,color:"#f59e0b"},{min:66,max:100,color:"#10b981"}]},onClick:null,onHover:null,onDetailedView:null};return this.deepMerge(t,e)}deepMerge(e,t){const n=Object.assign({},e);if(this.isObject(e)&&this.isObject(t)){for(const i of Object.keys(t))this.isObject(t[i])?i in e?n[i]=this.deepMerge(e[i],t[i]):n[i]=t[i]:n[i]=t[i];return n}return n}isObject(e){return e&&"object"==typeof e&&!Array.isArray(e)}setupEventListeners(){this.boundHandlers={mousemove:this.throttle(this.handleMouseMove.bind(this),16),mouseleave:this.handleMouseLeave.bind(this),click:this.handleClick.bind(this),dblclick:this.handleDoubleClick.bind(this),touchstart:this.handleTouchStart.bind(this),touchmove:this.throttle(this.handleTouchMove.bind(this),16),touchend:this.handleTouchEnd.bind(this),resize:this.throttle(this.handleResize.bind(this),250)},this.canvas.addEventListener("mousemove",this.boundHandlers.mousemove),this.canvas.addEventListener("mouseleave",this.boundHandlers.mouseleave),this.canvas.addEventListener("click",this.boundHandlers.click),this.canvas.addEventListener("dblclick",this.boundHandlers.dblclick),this.canvas.addEventListener("touchstart",this.boundHandlers.touchstart,{passive:!1}),this.canvas.addEventListener("touchmove",this.boundHandlers.touchmove,{passive:!1}),this.canvas.addEventListener("touchend",this.boundHandlers.touchend),window.addEventListener("resize",this.boundHandlers.resize)}throttle(e,t){let n;return function(...i){n||(e.apply(this,i),n=!0,setTimeout(()=>n=!1,t))}}handleMouseMove(e){const t=this.getCanvasPosition(e);this.updateHoverState(t.x,t.y,e)}handleTouchMove(e){e.preventDefault();const t=e.touches[0],n=this.getCanvasPosition(t);this.updateHoverState(n.x,n.y,t)}handleMouseLeave(){this.hoveredIndex=-1,this.hideTooltip(),this.redraw()}handleClick(e){-1!==this.hoveredIndex&&this.options.onClick&&this.options.onClick(e,this.hoveredIndex,this.getDataAtPoint(this.hoveredIndex),this)}handleDoubleClick(e){this.options.detailedView.enabled&&"doubleClick"===this.options.detailedView.trigger&&this.toggleDetailedView(e)}handleTouchStart(e){this.touchStartTime=Date.now();const t=e.touches[0],n=this.getCanvasPosition(t);this.touchStartX=n.x,this.touchStartY=n.y}handleTouchEnd(e){const t=Date.now()-this.touchStartTime;this.options.detailedView.enabled&&"longPress"===this.options.detailedView.trigger&&t>500&&this.toggleDetailedView(e.changedTouches[0])}handleResize(){if(this.options.responsive){const e=this.canvas.parentElement;if(e){const t=e.getBoundingClientRect();this.canvas.width=t.width,this.canvas.height=t.height,this.width=this.canvas.width,this.height=this.canvas.height,this.redraw()}}}getCanvasPosition(e){const t=this.canvas.getBoundingClientRect(),n=this.canvas.width/t.width,i=this.canvas.height/t.height;return{x:(e.clientX-t.left)*n,y:(e.clientY-t.top)*i,clientX:e.clientX,clientY:e.clientY}}updateHoverState(e,t,n){const i=this.hoveredIndex;if(this.hoveredIndex=this.getElementAtPosition(e,t),-1!==this.hoveredIndex)this.canvas.style.cursor="pointer",this.updateTooltip(n);else{this.canvas.style.cursor="default",this.hideTooltip()}i!==this.hoveredIndex&&(this.redraw(),this.options.onHover&&this.options.onHover(null,this.hoveredIndex,this.getDataAtPoint(this.hoveredIndex),this))}getElementAtPosition(e,t){const n=`element-${Math.floor(e)}-${Math.floor(t)}`;if(this.cache.has(n))return this.cache.get(n);let i=-1;switch(this.type){case"line":case"bar":i=this.getAxisChartElement(e,t);break;case"pie":case"doughnut":i=this.getCircularChartElement(e,t);break;case"funnel":i=this.getFunnelElement(e,t);break;case"gauge":i=this.getGaugeElement(e,t)}return this.cache.set(n,i),i}getAxisChartElement(e,t){if(!this.chartArea)return-1;if(e<this.chartArea.x||e>this.chartArea.x+this.chartArea.width||t<this.chartArea.y||t>this.chartArea.y+this.chartArea.height)return-1;const n=this.data.datasets[0],i=n.data.length;if("bar"===this.type){const t=this.chartArea.width/i*.7,n=this.chartArea.width/i*.15;for(let i=0;i<i;i++){const o=this.chartArea.x+(i/i)*this.chartArea.width+n;if(e>=o&&e<=o+t)return i}}else if("line"===this.type){const o=this.options.elements.point.hitRadius;for(let o=0;o<i;o++){const i=this.chartArea.x+(o/Math.max(i-1,1))*this.chartArea.width,r=this.getYPosition(n.data[o]),a=Math.sqrt(Math.pow(e-i,2)+Math.pow(t-r,2));if(a<=o)return o}}return-1}getCircularChartElement(e,t){const n=this.width/2,i=this.height/2,o=e-n,r=t-i,a=Math.sqrt(o*o+r*r),s=this.data.datasets[0],c=s.data.reduce((e,t)=>e+t,0),l=Math.min(this.width,this.height),d=(l/2)-60,u="doughnut"===this.type?d*.5:0;if(a<u||a>d)return-1;const h=Math.atan2(r,o)+Math.PI/2,p=h<0?h+2*Math.PI:h;let g=0;for(let e=0;e<s.data.length;e++){const t=(s.data[e]/c)*Math.PI*2;if(p>=g&&p<=g+t)return e;g+=t}return-1}getFunnelElement(e,t){if(!this.chartArea)return-1;const n=this.data.datasets[0],i=n.data,o=this.getSortedFunnelData(),r=this.chartArea.width*this.options.funnel.width,a=this.chartArea.height/i.length,s=a*this.options.funnel.gap;for(let n=0;n<o.length;n++){const i=this.chartArea.y+n*a,c=this.getFunnelSegmentWidth(n,o),l=this.getFunnelSegmentWidth(n+1,o),d=this.chartArea.x+(this.chartArea.width-c)/2;if(t>=i&&t<=i+a-s){const n=(t-i)/(a-s),a=c+(l-c)*n,o=this.chartArea.x+(this.chartArea.width-a)/2;if(e>=o&&e<=o+a)return o[n].originalIndex}}return-1}getGaugeElement(e,t){const n=this.width/2,i=this.height*.65,o=e-n,r=t-i,a=Math.sqrt(o*o+r*r),s=Math.min(this.width,this.height)/2-40,c=s*this.options.gauge.thickness,l=s-c;return a>=l&&a<=s?0:-1}getYPosition(e){const t=this.data.datasets[0],n=t.data,i=Math.max(...n),o=this.options.scales.y.beginAtZero?0:Math.min(...n),r=i-o||1;return this.chartArea.y+this.chartArea.height-((e-o)/r)*this.chartArea.height}updateTooltip(e){const t=this.getDataAtPoint(this.hoveredIndex);if(!t)return;this.tooltip||(this.tooltip=document.createElement("div"),this.tooltip.className="chartmaster-tooltip",document.body.appendChild(this.tooltip)),this.tooltip.innerHTML=`      <strong>${t.label}</strong>      Value: ${t.value}      ${t.percentage?`<br>Percentage: ${t.percentage}%`:""}    `,this.tooltip.style.left=e.clientX+"px",this.tooltip.style.top=e.clientY-this.tooltip.offsetHeight-15+"px",requestAnimationFrame(()=>{this.tooltip&&this.tooltip.classList.add("visible")});const n=this.tooltip.getBoundingClientRect();n.right>window.innerWidth-10&&(this.tooltip.style.left=window.innerWidth-n.width-10+"px"),n.top<10&&(this.tooltip.style.top=e.clientY+15+"px")}hideTooltip(){if(this.tooltip){this.tooltip.classList.remove("visible");setTimeout(()=>{this.tooltip&&!this.tooltip.classList.contains("visible")&&(this.tooltip.remove(),this.tooltip=null)},150)}}toggleDetailedView(e){this.detailedView?this.hideDetailedView():-1!==this.hoveredIndex&&this.showDetailedView(e)}showDetailedView(e){if(this.hideDetailedView(),!this.getDataAtPoint(this.hoveredIndex))return;this.detailedView=document.createElement("div"),this.detailedView.className="chartmaster-detailed-view";const t=this.calculateStats(),n=this.data.datasets[0];this.detailedView.innerHTML=`      <h4>Detailed Analysis</h4>      <div class="data-point">        <span>Label:</span>        <span>${t.label}</span>      </div>      <div class="data-point">        <span>Value:</span>        <span>${t.value}</span>      </div>      ${t.percentage?`      <div class="data-point">        <span>Percentage:</span>        <span>${t.percentage}%</span>      </div>      `:""}      <div class="data-point">        <span>Color:</span>        <span>          <span class="color-indicator" style="background-color: ${t.color};"></span>          ${t.color}        </span>      </div>      ${this.options.detailedView.showStats?`      <div class="section-divider">        <strong style="font-size: 13px; color: #333;">Statistics</strong>        <div class="data-point">          <span>Average:</span>          <span>${t.average.toFixed(2)}</span>        </div>        <div class="data-point">          <span>Median:</span>          <span>${t.median.toFixed(2)}</span>        </div>        <div class="data-point">          <span>Range:</span>          <span>${t.min} - ${t.max}</span>        </div>        <div class="data-point">          <span>Total:</span>          <span>${t.total.toFixed(2)}</span>        </div>        <div class="data-point">          <span>Count:</span>          <span>${n.data.length}</span>        </div>      </div>      `:""}      ${this.options.detailedView.showRawData?`      <div class="section-divider">        <strong style="font-size: 13px; color: #333;">All Data Points</strong>        ${this.data.labels.map((e,t)=>`          <div class="data-point">            <span>${e}:</span>            <span>${n.data[t]}</span>          </div>        `).join("")}      </div>      `:""}    `,document.body.appendChild(this.detailedView);let i=e.clientX,o=e.clientY+20;requestAnimationFrame(()=>{const e=this.detailedView.getBoundingClientRect();i+e.width>window.innerWidth-20&&(i=window.innerWidth-e.width-20),o+e.height>window.innerHeight-20&&(o=e.clientY-e.height-20),this.detailedView.style.left=i+"px",this.detailedView.style.top=o+"px"}),this.detailedViewClickListener=t=>{!this.detailedView.contains(t.target)&&t.target!==this.canvas&&this.hideDetailedView()},setTimeout(()=>{document.addEventListener("mousedown",this.detailedViewClickListener)},100),this.options.onDetailedView&&this.options.onDetailedView(e,this.hoveredIndex,t,this)}hideDetailedView(){this.detailedView&&this.detailedView.parentNode&&this.detailedView.remove(),this.detailedView=null,this.detailedViewClickListener&&(document.removeEventListener("mousedown",this.detailedViewClickListener),this.detailedViewClickListener=null)}getDataAtPoint(e){if(-1===e||!this.data.datasets[0])return null;const t=this.data.datasets[0];if("gauge"===this.type){const e=t.data[0];return{label:this.data.labels[0]||"Value",value:e,percentage:null,color:this.getGaugeColor(e)}}if("funnel"===this.type){const n=this.getSortedFunnelData(),i=n.find(t=>t.originalIndex===e);if(i){const e=t.data.reduce((e,t)=>e+t,0);return{label:i.label,value:i.value,percentage:((i.value/e)*100).toFixed(1),color:i.color}}}const n=this.data.labels[e],i=t.data[e];let o=null;return("pie"===this.type||"doughnut"===this.type||"funnel"===this.type)&&(o=((i/t.data.reduce((e,t)=>e+t,0))*100).toFixed(1)),{label:n,value:i,percentage:o,color:Array.isArray(t.backgroundColor)?t.backgroundColor[e%t.backgroundColor.length]:t.backgroundColor||"#3b82f6"}}calculateStats(){const e=this.data.datasets[0].data,t=[...e].sort((e,t)=>e-t),n=e.reduce((e,t)=>e+t,0),i=Math.floor(e.length/2),o=e.length%2==0?(t[i-1]+t[i])/2:t[i];return{average:n/e.length,median:o,min:t[0],max:t[e.length-1],total:n}}render(){this.cache.clear(),this.animationProgress=0,this.isAnimating=!0,this.frameId&&cancelAnimationFrame(this.frameId),this.animate()}animate(){const e=Date.now(),t=this.options.animation.duration;const n=()=>{const i=Date.now()-e;this.animationProgress=Math.min(i/t,1);const o=this.easing(this.animationProgress,this.options.animation.easing);this.draw(o),this.animationProgress<1?this.frameId=requestAnimationFrame(n):(this.isAnimating=!1,this.frameId=null)};this.frameId=requestAnimationFrame(n)}redraw(){this.cache.clear(),this.draw(1)}draw(e){this.clear(),this.calculateLayout(),this.calculateChartArea(),this.options.plugins.title.display&&this.drawTitle(),this.options.plugins.legend.display&&"gauge"!==this.type&&this.drawLegend();switch(this.type){case"line":this.drawLineChart(e);break;case"bar":this.drawBarChart(e);break;case"pie":this.drawPieChart(e);break;case"doughnut":this.drawDoughnutChart(e);break;case"funnel":this.drawFunnelChart(e);break;case"gauge":this.drawGaugeChart(e)}("line"===this.type||"bar"===this.type)&&(this.drawAxes(),this.drawGrid())}calculateLayout(){this.titleHeight=0,this.options.plugins.title.display&&(this.ctx.save(),this.ctx.font=`${this.options.plugins.title.font.weight||"bold"} ${this.options.plugins.title.font.size}px ${this.options.plugins.title.font.family}`;const e=this.ctx.measureText(this.options.plugins.title.text);this.titleHeight=e.actualBoundingBoxAscent+e.actualBoundingBoxDescent+this.options.plugins.title.padding.top+this.options.plugins.title.padding.bottom+10,this.ctx.restore()),this.legendHeight=0,this.legendWidth=0,this.options.plugins.legend.display&&"gauge"!==this.type&&(this.ctx.save(),this.ctx.font=`${this.options.plugins.legend.labels.font.size}px ${this.options.plugins.legend.labels.font.family}`;const t=("funnel"===this.type?this.getSortedFunnelData().map(e=>e.label):this.data.labels).map(e=>{const t=this.ctx.measureText(e).width;return t+this.options.plugins.legend.labels.boxWidth+2*this.options.plugins.legend.labels.padding});("top"===this.options.plugins.legend.position||"bottom"===this.options.plugins.legend.position)?(this.legendHeight=Math.max(...t.map(()=>this.options.plugins.legend.labels.boxWidth+this.options.plugins.legend.labels.padding))+2*this.options.plugins.legend.padding,this.legendWidth=this.width):(this.legendWidth=Math.max(...t)+2*this.options.plugins.legend.padding,this.legendHeight=this.height),this.ctx.restore()),this.axisHeight=0,this.axisWidth=0,("line"===this.type||"bar"===this.type)&&(this.options.scales.x.display||this.options.scales.y.display)&&(this.ctx.save(),this.ctx.font="11px Arial",this.options.scales.y.display&&(this.axisWidth=Math.max(this.axisWidth,this.ctx.measureText(this.getLongestYAxisLabel()).width+(this.options.scales.y.ticks?.padding||8)+15)),this.options.scales.x.display&&this.data.labels&&this.data.labels.length>0&&(this.axisHeight=this.ctx.measureText("M").actualBoundingBoxAscent+this.ctx.measureText("M").actualBoundingBoxDescent+(this.options.scales.x.ticks?.padding||8)+15),this.ctx.restore())}getLongestYAxisLabel(){const e=this.data.datasets[0].data,t=Math.max(...e,0),n=this.options.scales.y.beginAtZero?0:Math.min(...e,0),i=[];for(let e=0;e<=5;e++)i.push((n+e/5*(t-n)).toFixed(1));return i.reduce((e,t)=>e.length>t.length?e:t)}calculateChartArea(){const e=this.options.layout.padding,t=this.options.plugins.legend;let n=e.top+this.titleHeight,i=e.bottom+this.axisHeight,o=e.left+this.axisWidth,r=e.right;t.display&&"gauge"!==this.type&&(switch(t.position){case"top":n+=this.legendHeight;break;case"bottom":i+=this.legendHeight;break;case"left":o+=this.legendWidth;break;case"right":r+=this.legendWidth}break),this.chartArea={x:o,y:n,width:Math.max(0,this.width-o-r),height:Math.max(0,this.height-n-i)}}drawLineChart(e){const t=this.data.datasets[0],n=t.data,i=Math.max(...n),o=this.options.scales.y.beginAtZero?0:Math.min(...n),r=i-o||1;this.drawAxisLabels(o,r);const a=[],s=Math.ceil(n.length*e);this.ctx.save(),this.ctx.strokeStyle=t.borderColor||"#3b82f6",this.ctx.lineWidth=this.options.elements.line.borderWidth,this.ctx.lineJoin="round",this.ctx.lineCap="round",this.ctx.beginPath();for(let e=0;e<s;e++){const s=this.chartArea.x+(e/Math.max(n.length-1,1))*this.chartArea.width,c=n[e],l=this.chartArea.y+this.chartArea.height-((c-o)/r)*this.chartArea.height;a.push({x:s,y:l,index:e}),0===e?this.ctx.moveTo(s,l):this.options.elements.line.tension>0?this.ctx.quadraticCurveTo((a[e-1].x+s)/2,a[e-1].y,s,l):this.ctx.lineTo(s,l)}this.ctx.stroke(),this.options.elements.line.fill&&a.length>0&&(this.ctx.globalAlpha=.15,this.ctx.fillStyle=t.backgroundColor||t.borderColor||"#3b82f6",this.ctx.lineTo(a[a.length-1].x,this.chartArea.y+this.chartArea.height),this.ctx.lineTo(a[0].x,this.chartArea.y+this.chartArea.height),this.ctx.closePath(),this.ctx.fill(),this.ctx.globalAlpha=1),a.forEach(e=>{const t=this.hoveredIndex===e.index?this.options.elements.point.hoverRadius:this.options.elements.point.radius;this.ctx.fillStyle="#fff",this.ctx.strokeStyle=t.borderColor||"#3b82f6",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,t,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke()}),this.ctx.restore()}drawBarChart(e){const t=this.data.datasets[0],n=t.data,i=Math.max(...n,0),o=this.options.scales.y.beginAtZero?0:Math.min(...n,0),r=i-o||1;this.drawAxisLabels(o,r);const a=this.chartArea.width/n.length*.7,s=this.chartArea.width/n.length*.15;this.ctx.save(),n.forEach((n,i)=>{const c=this.chartArea.x+(i/n.length)*this.chartArea.width+s,l=Math.abs((n-o)/r)*this.chartArea.height*e,d=n>=0?this.chartArea.y+this.chartArea.height-l:this.chartArea.y+this.chartArea.height,u=this.hoveredIndex===i,h=Array.isArray(t.backgroundColor)?t.backgroundColor[i%t.backgroundColor.length]:t.backgroundColor||"#3b82f6";this.ctx.fillStyle=u?this.lightenColor(h,15):h;const p=this.options.elements.bar.borderRadius;this.roundRect(this.ctx,c,d,a,l,p),this.ctx.fill(),this.options.elements.bar.borderWidth>0&&(this.ctx.strokeStyle=t.borderColor||"#fff",this.ctx.lineWidth=this.options.elements.bar.borderWidth,this.ctx.stroke())}),this.ctx.restore()}drawPieChart(e){this.drawCircularChart(e,0)}drawDoughnutChart(e){const t=Math.min(this.width,this.height)/2-60,n=t*.5;this.drawCircularChart(e,n)}drawCircularChart(e,t){const n=this.data.datasets[0],i=n.data,o=i.reduce((e,t)=>e+t,0),r=this.width/2,a=this.chartArea.y+this.chartArea.height/2,s=Math.min(this.chartArea.width,this.chartArea.height),c=(s/2)-20;let l=-Math.PI/2;this.ctx.save(),i.forEach((i,s)=>{const d=(i/o)*Math.PI*2*e,u=this.hoveredIndex===s?this.options.elements.arc.hoverOffset:0,h=l+d/2,p=Math.cos(h)*u,g=Math.sin(h)*u,f=Array.isArray(n.backgroundColor)?n.backgroundColor[s%n.backgroundColor.length]:n.backgroundColor||"#3b82f6";this.ctx.fillStyle=u?this.lightenColor(f,10):f,this.ctx.beginPath(),t>0?(this.ctx.arc(r+p,a+g,c,l,l+d),this.ctx.arc(r+p,a+g,t,l+d,l,!0)):(this.ctx.moveTo(r+p,a+g),this.ctx.arc(r+p,a+g,c,l,l+d)),this.ctx.closePath(),this.ctx.fill(),this.options.elements.arc.borderWidth>0&&(this.ctx.strokeStyle=this.options.elements.arc.borderColor,this.ctx.lineWidth=this.options.elements.arc.borderWidth,this.ctx.stroke()),l+=d}),this.ctx.restore()}getSortedFunnelData(){const e=this.data.datasets[0];return e.data.map((t,n)=>({value:t,label:this.data.labels[n],originalIndex:n,color:Array.isArray(e.backgroundColor)?e.backgroundColor[n%e.backgroundColor.length]:e.backgroundColor||"#3b82f6"})).sort((e,t)=>{"desc"===this.options.funnel.sort?e=t.value-e.value:"asc"===this.options.funnel.sort&&(e=e.value-t.value);return e})}getFunnelSegmentWidth(e,t){if(e>=t.length)return this.chartArea.width*this.options.funnel.width*.3;if(0===e)return this.chartArea.width*this.options.funnel.width;const n=Math.max(...t.map(e=>e.value)),i=t[e].value/n;return this.chartArea.width*this.options.funnel.width*(.3+.7*i)}drawFunnelChart(e){const t=this.getSortedFunnelData(),n=this.chartArea.height/t.length,i=n*this.options.funnel.gap;this.ctx.save(),t.forEach((t,o)=>{const r=Math.max(0,Math.min(1,(e-o/t.length)*t.length));if(r<=0)return;const a=this.getFunnelSegmentWidth(o,t)*r,s=this.getFunnelSegmentWidth(o+1,t)*r,c=this.chartArea.y+o*n,l=this.chartArea.x+(this.chartArea.width-a)/2,d=this.chartArea.x+(this.chartArea.width-s)/2,u=this.hoveredIndex===t.originalIndex;this.ctx.fillStyle=u?this.lightenColor(t.color,15):t.color,this.ctx.beginPath(),this.ctx.moveTo(l,c),this.ctx.lineTo(l+a,c),this.ctx.lineTo(d+s,c+n-i),this.ctx.lineTo(d,c+n-i),this.ctx.closePath(),this.ctx.fill(),this.options.elements.bar.borderWidth>0&&(this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.stroke()),this.ctx.fillStyle="#fff",this.ctx.font="bold 13px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const h=c+(n-i)/2;this.ctx.fillText(t.label,this.chartArea.x+this.chartArea.width/2,h-8),this.ctx.font="12px Arial",this.ctx.fillText(t.value.toFixed(0),this.chartArea.x+this.chartArea.width/2,h+8)}),this.ctx.restore()}getGaugeColor(e){for(const t of this.options.gauge.ranges)if(e>=t.min&&e<=t.max)return t.color;return this.options.gauge.ranges[this.options.gauge.ranges.length-1].color}drawGaugeChart(e){const t=this.data.datasets[0].data[0],n=0,i=100,o=this.width/2,r=this.chartArea.y+this.chartArea.height*.65,a=Math.min(this.chartArea.width,this.chartArea.height)/2,s=a*.75,c=s*.25,l=s-c,d=(this.options.gauge.startAngle*Math.PI)/180,u=(this.options.gauge.endAngle*Math.PI)/180,h=u-d;this.ctx.save(),this.ctx.lineCap="round";const p=this.options.gauge.ranges,g=.015;p.forEach((t,n)=>{const i=d+(t.min/i)*h+(n>0?g:0),r=d+(t.max/i)*h-g;this.ctx.lineWidth=c,this.ctx.strokeStyle=t.color,this.ctx.beginPath(),this.ctx.arc(o,r,l+c/2,i,r),this.ctx.stroke()});const f=d+((t/i)*h)*e,y=l-10,m=6;this.ctx.fillStyle="#2c3e50",this.ctx.beginPath(),this.ctx.moveTo(o+Math.cos(f-Math.PI/2)*m/2,r+Math.sin(f-Math.PI/2)*m/2),this.ctx.lineTo(o+Math.cos(f)*y,r+Math.sin(f)*y),this.ctx.lineTo(o+Math.cos(f+Math.PI/2)*m/2,r+Math.sin(f+Math.PI/2)*m/2),this.ctx.closePath(),this.ctx.fill();const v=12;this.ctx.fillStyle="#2c3e50",this.ctx.beginPath(),this.ctx.arc(o,r,v,0,2*Math.PI),this.ctx.fill(),this.options.gauge.showValue&&(this.ctx.fillStyle=this.getGaugeColor(t),this.ctx.font="bold 48px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(this.options.gauge.valueFormat(t*e),o,r-10),this.ctx.font="16px Arial",this.ctx.fillStyle="#bbb",this.ctx.fillText(this.data.labels[0]||"",o,r+25)),this.ctx.font="14px Arial",this.ctx.fillStyle="#999",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const x=o+Math.cos(d)*(s+c/2+15),b=r+Math.sin(d)*(s+c/2+15);this.ctx.fillText(n.toString(),x,b);const _=o+Math.cos(u)*(s+c/2+15),w=r+Math.sin(u)*(s+c/2+15);this.ctx.fillText(i.toString(),_,w),this.ctx.restore()}drawTitle(){const e=this.options.plugins.title;this.ctx.save(),this.ctx.font=`${e.font.weight||"bold"} ${e.font.size}px ${e.font.family}`,this.ctx.fillStyle=e.color,this.ctx.textAlign=e.align||"center",this.ctx.textBaseline="top";const t="start"===e.align?this.options.layout.padding.left:"end"===e.align?this.width-this.options.layout.padding.right:this.width/2;this.ctx.fillText(e.text,t,this.options.layout.padding.top+e.padding.top),this.ctx.restore()}drawLegend(){const e=this.options.plugins.legend,t=this.data.datasets[0],n="funnel"===this.type?this.getSortedFunnelData().map(e=>e.label):this.data.labels;this.ctx.save(),this.ctx.font=`${e.labels.font.size}px ${e.labels.font.family}`,this.ctx.textBaseline="middle";const i=n.map(e=>{const t=this.ctx.measureText(e).width;return t+e.labels.boxWidth+2*e.labels.padding}),o=i.reduce((e,t)=>e+t,0),r=e.labels.boxWidth+e.labels.padding;let a,s;switch(e.position){case"top":a="start"===e.align?this.options.layout.padding.left:"end"===e.align?this.width-o-this.options.layout.padding.right:(this.width-o)/2,s=this.options.layout.padding.top+this.titleHeight+e.padding;break;case"bottom":a="start"===e.align?this.options.layout.padding.left:"end"===e.align?this.width-o-this.options.layout.padding.right:(this.width-o)/2,s=this.height-this.options.layout.padding.bottom-this.legendHeight+e.padding;break;case"left":a=this.options.layout.padding.left+e.padding,s=this.chartArea.y+(this.chartArea.height-n.length*r)/2;break;case"right":a=this.width-this.options.layout.padding.right-this.legendWidth+e.padding,s=this.chartArea.y+(this.chartArea.height-n.length*r)/2}let c=a,l=s;n.forEach((n,i)=>{const o=Array.isArray(t.backgroundColor)?t.backgroundColor[i%t.backgroundColor.length]:t.backgroundColor||"#3b82f6";if(this.ctx.fillStyle=o,e.labels.usePointStyle)this.ctx.beginPath(),this.ctx.arc(c+e.labels.boxWidth/2,l,e.labels.boxWidth/2,0,2*Math.PI),this.ctx.fill();else{const e=c,t=l-e.labels.boxWidth/2,n=e.labels.boxWidth,i=e.labels.boxWidth;this.roundRect(this.ctx,e,t,n,i,2),this.ctx.fill()}this.ctx.fillStyle=e.labels.color,this.ctx.textAlign="left",this.ctx.fillText(n,c+e.labels.boxWidth+e.labels.padding,l),("left"===e.position||"right"===e.position)?l+=r:c+=i[i]}),this.ctx.restore()}drawAxes(){this.options.scales.x.display||this.options.scales.y.display?(this.ctx.save(),this.ctx.strokeStyle="#999",this.ctx.lineWidth=1,this.ctx.beginPath(),this.options.scales.y.display&&(this.ctx.moveTo(this.chartArea.x,this.chartArea.y),this.ctx.lineTo(this.chartArea.x,this.chartArea.y+this.chartArea.height)),this.options.scales.x.display&&(this.ctx.moveTo(this.chartArea.x,this.chartArea.y+this.chartArea.height),this.ctx.lineTo(this.chartArea.x+this.chartArea.width,this.chartArea.y+this.chartArea.height)),this.ctx.stroke(),this.ctx.restore()):void 0}drawGrid(){const e=this.options.scales.x.grid,t=this.options.scales.y.grid;if(e.display||t.display){this.ctx.save(),this.ctx.lineWidth=1,t.display&&(this.ctx.strokeStyle=t.color,this.drawHorizontalGridLines()),e.display&&(this.ctx.strokeStyle=e.color,this.drawVerticalGridLines()),this.ctx.restore()}}drawHorizontalGridLines(){for(let e=0;e<=5;e++){const t=this.chartArea.y+(e/5)*this.chartArea.height;this.ctx.beginPath(),this.ctx.moveTo(this.chartArea.x,t),this.ctx.lineTo(this.chartArea.x+this.chartArea.width,t),this.ctx.stroke()}}drawVerticalGridLines(){const e=this.data.labels.length;for(let t=0;t<e;t++){const n=this.chartArea.x+(t/Math.max(e-1,1))*this.chartArea.width;this.ctx.beginPath(),this.ctx.moveTo(n,this.chartArea.y),this.ctx.lineTo(n,this.chartArea.y+this.chartArea.height),this.ctx.stroke()}}drawAxisLabels(e,t){this.options.scales.x.display||this.options.scales.y.display?(this.ctx.save(),this.options.scales.y.display&&this.drawYAxisLabels(e,t),this.options.scales.x.display&&this.drawXAxisLabels(),this.ctx.restore()):void 0}drawYAxisLabels(e,t){const n=this.options.scales.y.ticks||{};this.ctx.font=`${n.font?.size||11}px Arial`,this.ctx.fillStyle=n.color||"#666",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let n=0;n<=5;n++){const i=e+(n/5)*(t-e),o=this.chartArea.y+this.chartArea.height-(n/5)*this.chartArea.height;this.ctx.fillText(i.toFixed(1),this.chartArea.x-10,o)}}drawXAxisLabels(){const e=this.options.scales.x.ticks||{};this.ctx.font=`${e.font?.size||11}px Arial`,this.ctx.fillStyle=e.color||"#666",this.ctx.textAlign="center",this.ctx.textBaseline="top",this.data.labels.forEach((e,t)=>{const n=this.chartArea.x+(t/Math.max(this.data.labels.length-1,1))*this.chartArea.width;this.ctx.fillText(e,n,this.chartArea.y+this.chartArea.height+5)})}clear(){this.ctx.clearRect(0,0,this.width,this.height),this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(0,0,this.width,this.height)}setBackgroundColor(e){this.backgroundColor=e,this.redraw()}roundRect(e,t,n,i,o){e.beginPath(),e.moveTo(t+o,n),e.lineTo(t+i-o,n),e.quadraticCurveTo(t+i,n,t+i,n+o),e.lineTo(t+i,n+i-o),e.quadraticCurveTo(t+i,n+i,t+i-o,n+i),e.lineTo(t+o,n+i),e.quadraticCurveTo(t,n+i,t,n+i-o),e.lineTo(t,n+o),e.quadraticCurveTo(t,n,t+o,n),e.closePath()}lightenColor(e,t){if(!e||"transparent"===e)return"#3b82f6";let n,i,o;if(e.startsWith("#")){const t=e.replace("#","");n=parseInt(t.substr(0,2),16),i=parseInt(t.substr(2,2),16),o=parseInt(t.substr(4,2),16)}else if(e.startsWith("rgb")){const t=e.match(/(\d+),\s*(\d+),\s*(\d+)/);t?(n=parseInt(t[1]),i=parseInt(t[2]),o=parseInt(t[3])):e}else return e;const r=Math.round(2.55*t);return n=Math.min(255,n+r),i=Math.min(255,i+r),o=Math.min(255,o+r),`rgb(${n}, ${i}, ${o})`}easing(e,t){const n={linear:e=>e,easeInQuad:e=>e*e,easeOutQuad:e=>e*(2-e),easeInOutQuad:e=>e<.5?2*e*e:-1+(4-2*e)*e,easeOutQuart:e=>1-Math.pow(1-e,4),easeInOutCubic:e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,easeOutElastic:e=>{const t=.3;return Math.pow(2,-10*e)*Math.sin((e-t/4)*(2*Math.PI)/t)+1}};return n[t]?n[t](e):n.easeOutQuart(e)}update(e){this.cache.clear(),e.data&&(this.data=e.data),e.options&&(this.options=this.mergeOptions(e.options)),e.type&&(this.type=e.type),e.backgroundColor&&(this.backgroundColor=e.backgroundColor),this.render()}destroy(){this.removeEventListeners(),this.hideTooltip(),this.hideDetailedView(),this.clear(),this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=null),this.cache.clear()}removeEventListeners(){if(!this.boundHandlers)return;this.canvas.removeEventListener("mousemove",this.boundHandlers.mousemove),this.canvas.removeEventListener("mouseleave",this.boundHandlers.mouseleave),this.canvas.removeEventListener("click",this.boundHandlers.click),this.canvas.removeEventListener("dblclick",this.boundHandlers.dblclick),this.canvas.removeEventListener("touchstart",this.boundHandlers.touchstart),this.canvas.removeEventListener("touchmove",this.boundHandlers.touchmove),this.canvas.removeEventListener("touchend",this.boundHandlers.touchend),window.removeEventListener("resize",this.boundHandlers.resize),this.detailedViewClickListener&&(document.removeEventListener("mousedown",this.detailedViewClickListener),this.detailedViewClickListener=null),this.boundHandlers={}}}return"undefined"!=typeof module&&module.exports?module.exports=e:"undefined"!=typeof window&&(window.ChartMaster=e),e});