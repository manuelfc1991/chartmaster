/**
 * ChartMaster.js - Enhanced Professional Charting Library
 * @version 4.0.1
 * @license MIT
 */
class ChartMaster{constructor(t,i){if(this.canvas=document.getElementById(t),!this.canvas)throw new Error(`Canvas "${t}" not found`);this.ctx=this.canvas.getContext("2d",{alpha:!1,desynchronized:!0}),this.width=this.canvas.width,this.height=this.canvas.height,this.type=i.type||"line",this.data=i.data||{},this.options=this.mergeOptions(i.options||{}),this.animationProgress=0,this.isAnimating=!1,this.hoveredIndex=-1,this.tooltipData=null,this.chartArea=null,this.scales={x:null,y:null},this.detailedView=null,this.titleHeight=0,this.legendHeight=0,this.legendWidth=0,this.axisHeight=0,this.axisWidth=0,this.cache=new Map,this.frameId=null,this.boundHandlers={},this.touchStartTime=0,this.touchStartX=0,this.touchStartY=0,this.hoverAnimations=new Map,this.backgroundColor=i.backgroundColor||"#ffffff",this.setupStyles(),this.setupEventListeners(),this.render()}setupStyles(){if(document.getElementById("chartmaster-styles"))return;const t=document.createElement("style");t.id="chartmaster-styles",t.textContent="\n      .chartmaster-tooltip {\n        position: fixed;\n        background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(20, 20, 20, 0.95));\n        color: white;\n        padding: 12px 16px;\n        border-radius: 10px;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;\n        font-size: 13px;\n        pointer-events: none;\n        z-index: 10000;\n        box-shadow: 0 8px 32px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);\n        backdrop-filter: blur(12px);\n        white-space: nowrap;\n        max-width: 280px;\n        opacity: 0;\n        transform: translateY(-5px) scale(0.95);\n        transition: opacity 0.2s cubic-bezier(0.16, 1, 0.3, 1), \n                    transform 0.2s cubic-bezier(0.16, 1, 0.3, 1);\n      }\n      \n      .chartmaster-tooltip.visible {\n        opacity: 1;\n        transform: translateY(0) scale(1);\n      }\n      \n      .chartmaster-tooltip::before {\n        content: '';\n        position: absolute;\n        top: 100%;\n        left: 50%;\n        transform: translateX(-50%);\n        border: 7px solid transparent;\n        border-top-color: rgba(0, 0, 0, 0.95);\n        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));\n      }\n      \n      .chartmaster-tooltip strong {\n        display: block;\n        margin-bottom: 6px;\n        font-size: 14px;\n        font-weight: 600;\n        letter-spacing: 0.3px;\n      }\n      \n      .chartmaster-detailed-view {\n        position: fixed;\n        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);\n        border: 1px solid rgba(0,0,0,0.08);\n        border-radius: 16px;\n        padding: 24px;\n        box-shadow: 0 20px 60px rgba(0,0,0,0.15), \n                    0 0 0 1px rgba(0,0,0,0.05);\n        z-index: 10001;\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;\n        max-width: 360px;\n        min-width: 300px;\n        backdrop-filter: blur(20px);\n        animation: chartmaster-slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);\n      }\n      \n      .chartmaster-detailed-view h4 {\n        margin: 0 0 16px 0;\n        color: #1a1a1a;\n        font-size: 18px;\n        font-weight: 700;\n        border-bottom: 2px solid #e8eaed;\n        padding-bottom: 12px;\n        letter-spacing: -0.3px;\n      }\n      \n      .chartmaster-detailed-view p {\n        margin: 8px 0;\n        color: #5f6368;\n        font-size: 13px;\n        line-height: 1.5;\n      }\n      \n      .chartmaster-detailed-view .data-point {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin: 12px 0;\n        padding: 10px 12px;\n        background: rgba(255,255,255,0.6);\n        border-radius: 8px;\n        transition: background 0.2s ease;\n      }\n      \n      .chartmaster-detailed-view .data-point:hover {\n        background: rgba(255,255,255,0.9);\n      }\n      \n      .chartmaster-detailed-view .data-point:last-child {\n        border-bottom: none;\n      }\n      \n      .chartmaster-detailed-view .data-point span:first-child {\n        color: #5f6368;\n        font-size: 13px;\n        font-weight: 500;\n      }\n      \n      .chartmaster-detailed-view .data-point span:last-child {\n        font-weight: 600;\n        color: #202124;\n        font-size: 14px;\n      }\n      \n      .chartmaster-detailed-view .color-indicator {\n        width: 16px;\n        height: 16px;\n        border-radius: 4px;\n        display: inline-block;\n        margin-right: 10px;\n        vertical-align: middle;\n        box-shadow: 0 2px 8px rgba(0,0,0,0.15), inset 0 0 0 1px rgba(255,255,255,0.3);\n      }\n      \n      .chartmaster-detailed-view .section-divider {\n        margin: 20px 0;\n        padding-top: 20px;\n        border-top: 2px solid #e8eaed;\n      }\n      \n      .chartmaster-detailed-view .section-divider strong {\n        color: #202124;\n        font-size: 14px;\n        font-weight: 600;\n        letter-spacing: -0.2px;\n      }\n      \n      @keyframes chartmaster-slideIn {\n        from { \n          opacity: 0; \n          transform: scale(0.92) translateY(-15px); \n        }\n        to { \n          opacity: 1; \n          transform: scale(1) translateY(0); \n        }\n      }\n    ",document.head.appendChild(t)}mergeOptions(t){return this.deepMerge({responsive:!0,maintainAspectRatio:!0,backgroundColor:"#ffffff",indexAxis:"x",animation:{duration:900,easing:"easeOutQuart"},plugins:{legend:{display:!0,position:"top",align:"center",labels:{color:"#666",font:{size:12,family:"Arial",weight:"500"},padding:14,boxWidth:14,usePointStyle:!1},padding:16},title:{display:!1,text:"",color:"#1a1a1a",font:{size:18,weight:"bold",family:"Arial"},padding:{top:12,bottom:16},align:"center"},tooltip:{enabled:!0,mode:"nearest"},detailedView:{enabled:!0,trigger:"doubleClick",position:"auto",showStats:!0,showRawData:!1,customFields:[],template:null,style:{}}},scales:{x:{display:!0,title:{display:!1,text:"",color:"#666",font:{size:12,family:"Arial"}},grid:{display:!0,color:"rgba(0, 0, 0, 0.06)"},ticks:{padding:10,maxRotation:0,color:"#666"}},y:{display:!0,beginAtZero:!0,title:{display:!1,text:"",color:"#666",font:{size:12,family:"Arial"}},grid:{display:!0,color:"rgba(0, 0, 0, 0.06)"},ticks:{padding:10,color:"#666"}}},layout:{padding:{top:20,right:20,bottom:20,left:20},autoPadding:!0},elements:{line:{borderWidth:3,tension:.4,fill:!1,gradient:!0,shadow:!0,glowEffect:!1},point:{radius:4,hoverRadius:6,hitRadius:12,shadow:!0},bar:{borderWidth:0,borderRadius:6,gradient:!0,shadow:!0,hoverScale:1.03},arc:{borderWidth:3,borderColor:"#fff",hoverOffset:12,shadow:!0}},funnel:{width:.7,gap:.02,sort:"desc"},gauge:{startAngle:-135,endAngle:135,thickness:.22,showValue:!0,valueFormat:t=>t.toFixed(1),ranges:[{min:0,max:33,color:"#ef4444"},{min:33,max:66,color:"#f59e0b"},{min:66,max:100,color:"#10b981"}]},waterfall:{positiveColor:"#10b981",negativeColor:"#ef4444",totalColor:"#3b82f6",connectorLine:!0,connectorColor:"rgba(0,0,0,0.2)",connectorStyle:"dashed",showValues:!0},conversionFunnel:{width:.8,gap:0,sort:"desc",showConversionRates:!0,conversionRatePosition:"line",conversionRateFont:{size:13,weight:"600",color:"#333"},showValues:!0,valueFontSize:18,labelFontSize:13,connectorLineWidth:2,connectorLineColor:"#fff"},onClick:null,onHover:null,onDetailedView:null},t)}deepMerge(t,i){const e=Object.assign({},t);return this.isObject(t)&&this.isObject(i)&&Object.keys(i).forEach((s=>{this.isObject(i[s])?e[s]=s in t?this.deepMerge(t[s],i[s]):i[s]:e[s]=i[s]})),e}isObject(t){return t&&"object"==typeof t&&!Array.isArray(t)}setupEventListeners(){this.boundHandlers={mousemove:this.throttle(this.handleMouseMove.bind(this),16),mouseleave:this.handleMouseLeave.bind(this),click:this.handleClick.bind(this),dblclick:this.handleDoubleClick.bind(this),touchstart:this.handleTouchStart.bind(this),touchmove:this.throttle(this.handleTouchMove.bind(this),16),touchend:this.handleTouchEnd.bind(this),resize:this.throttle(this.handleResize.bind(this),250)},this.canvas.addEventListener("mousemove",this.boundHandlers.mousemove),this.canvas.addEventListener("mouseleave",this.boundHandlers.mouseleave),this.canvas.addEventListener("click",this.boundHandlers.click),this.canvas.addEventListener("dblclick",this.boundHandlers.dblclick),this.canvas.addEventListener("touchstart",this.boundHandlers.touchstart,{passive:!1}),this.canvas.addEventListener("touchmove",this.boundHandlers.touchmove,{passive:!1}),this.canvas.addEventListener("touchend",this.boundHandlers.touchend),window.addEventListener("resize",this.boundHandlers.resize),this.waterfallRunningTotal=0}throttle(t,i){let e;return function(...s){e||(t.apply(this,s),e=!0,setTimeout((()=>e=!1),i))}}handleMouseMove(t){const i=this.getCanvasPosition(t);this.updateHoverState(i.x,i.y,t)}handleTouchMove(t){t.preventDefault();const i=t.touches[0],e=this.getCanvasPosition(i);this.updateHoverState(e.x,e.y,i)}handleMouseLeave(){this.hoveredIndex=-1,this.hideTooltip(),this.redraw()}handleClick(t){-1!==this.hoveredIndex&&(this.options.plugins.detailedView.enabled&&"click"===this.options.plugins.detailedView.trigger&&this.toggleDetailedView(t),this.options.onClick&&this.options.onClick(t,this.hoveredIndex,this.getDataAtPoint(this.hoveredIndex),this))}handleDoubleClick(t){this.options.plugins.detailedView.enabled&&"doubleClick"===this.options.plugins.detailedView.trigger&&this.toggleDetailedView(t)}handleTouchStart(t){this.touchStartTime=Date.now();const i=t.touches[0],e=this.getCanvasPosition(i);this.touchStartX=e.x,this.touchStartY=e.y}handleTouchEnd(t){const i=Date.now()-this.touchStartTime;if(this.options.plugins.detailedView.enabled&&"longPress"===this.options.plugins.detailedView.trigger&&i>500){const i=t.changedTouches[0];this.toggleDetailedView(i)}}handleResize(){if(this.options.responsive){const t=this.canvas.parentElement;if(t){const i=t.getBoundingClientRect();this.canvas.width=i.width,this.canvas.height=i.height,this.width=this.canvas.width,this.height=this.canvas.height,this.redraw()}}}getCanvasPosition(t){const i=this.canvas.getBoundingClientRect(),e=this.canvas.width/i.width,s=this.canvas.height/i.height;return{x:(t.clientX-i.left)*e,y:(t.clientY-i.top)*s,clientX:t.clientX,clientY:t.clientY}}updateHoverState(t,i,e){const s=this.hoveredIndex;this.hoveredIndex=this.getElementAtPosition(t,i),-1!==this.hoveredIndex?(this.canvas.style.cursor="pointer",this.updateTooltip(e)):(this.canvas.style.cursor="default",this.hideTooltip()),s!==this.hoveredIndex&&(this.redraw(),this.options.onHover&&this.options.onHover(null,this.hoveredIndex,this.getDataAtPoint(this.hoveredIndex),this))}getElementAtPosition(t,i){const e=`element-${Math.floor(t)}-${Math.floor(i)}`;if(this.cache.has(e))return this.cache.get(e);let s=-1;switch(this.type){case"line":case"bar":case"horizontalBar":case"waterfall":s=this.getAxisChartElement(t,i);break;case"pie":case"doughnut":s=this.getCircularChartElement(t,i);break;case"funnel":s=this.getFunnelElement(t,i);break;case"gauge":s=this.getGaugeElement(t,i);break;case"conversionFunnel":s=this.getConversionFunnelElement(t,i)}return this.cache.set(e,s),s}getAxisChartElement(t,i){if(!this.chartArea)return-1;if(t<this.chartArea.x||t>this.chartArea.x+this.chartArea.width||i<this.chartArea.y||i>this.chartArea.y+this.chartArea.height)return-1;const e=this.data.datasets[0],s=e.data.length,a="horizontalBar"===this.type;if("bar"===this.type||"horizontalBar"===this.type){const e=(a?this.chartArea.height:this.chartArea.width)/s*.7,h=(a?this.chartArea.height:this.chartArea.width)/s*.15;for(let n=0;n<s;n++)if(a){const t=this.chartArea.y+n/s*this.chartArea.height+h;if(i>=t&&i<=t+e)return n}else{const i=this.chartArea.x+n/s*this.chartArea.width+h;if(t>=i&&t<=i+e)return n}}else if("line"===this.type){const a=this.options.elements.point.hitRadius;for(let h=0;h<s;h++){const n=this.chartArea.x+h/Math.max(s-1,1)*this.chartArea.width,o=this.getYPosition(e.data[h]);if(Math.sqrt(Math.pow(t-n,2)+Math.pow(i-o,2))<=a)return h}}return-1}getCircularChartElement(t,i){const e=t-this.width/2,s=i-this.height/2,a=Math.sqrt(e*e+s*s),h=this.data.datasets[0],n=h.data.reduce(((t,i)=>t+i),0),o=Math.min(this.width,this.height)/2-60;if(a<("doughnut"===this.type?.5*o:0)||a>o)return-1;const r=Math.atan2(s,e)+Math.PI/2,l=r<0?r+2*Math.PI:r;let c=0;for(let t=0;t<h.data.length;t++){const i=h.data[t]/n*Math.PI*2;if(l>=c&&l<=c+i)return t;c+=i}return-1}getFunnelElement(t,i){if(!this.chartArea)return-1;const e=this.data.datasets[0].data,s=this.getSortedFunnelData(),a=this.chartArea.height/e.length,h=a*this.options.funnel.gap;for(let e=0;e<s.length;e++){const n=this.chartArea.y+e*a,o=this.getFunnelSegmentWidth(e,s),r=this.getFunnelSegmentWidth(e+1,s);if(i>=n&&i<=n+a-h){const l=o+(r-o)*((i-n)/(a-h)),c=this.chartArea.x+(this.chartArea.width-l)/2;if(t>=c&&t<=c+l)return s[e].originalIndex}}return-1}getGaugeElement(t,i){const e=t-this.width/2,s=i-.65*this.height,a=Math.sqrt(e*e+s*s),h=Math.min(this.width,this.height)/2-40;return a>=h-h*this.options.gauge.thickness&&a<=h?0:-1}getYPosition(t){const i=this.data.datasets[0].data,e=Math.max(...i),s=this.options.scales.y.beginAtZero?0:Math.min(...i),a=e-s||1;return this.chartArea.y+this.chartArea.height-(t-s)/a*this.chartArea.height}updateTooltip(t){const i=this.getDataAtPoint(this.hoveredIndex);if(!i)return;this.tooltip||(this.tooltip=document.createElement("div"),this.tooltip.className="chartmaster-tooltip",document.body.appendChild(this.tooltip)),this.tooltip.innerHTML=`\n      <strong>${i.label}</strong>\n      Value: ${i.value}\n      ${i.percentage?`<br>Percentage: ${i.percentage}%`:""}\n    `,this.tooltip.style.left=t.clientX+"px",this.tooltip.style.top=t.clientY-this.tooltip.offsetHeight-18+"px",requestAnimationFrame((()=>{this.tooltip&&this.tooltip.classList.add("visible")}));const e=this.tooltip.getBoundingClientRect();e.right>window.innerWidth-10&&(this.tooltip.style.left=window.innerWidth-e.width-10+"px"),e.top<10&&(this.tooltip.style.top=t.clientY+18+"px")}hideTooltip(){this.tooltip&&(this.tooltip.classList.remove("visible"),setTimeout((()=>{this.tooltip&&!this.tooltip.classList.contains("visible")&&(this.tooltip.remove(),this.tooltip=null)}),200))}toggleDetailedView(t){this.detailedView?this.hideDetailedView():-1!==this.hoveredIndex&&this.showDetailedView(t)}showDetailedView(t){this.hideDetailedView();const i=this.getDataAtPoint(this.hoveredIndex);if(!i)return;const e=this.options.plugins.detailedView;this.detailedView=document.createElement("div"),this.detailedView.className="chartmaster-detailed-view",e.style&&Object.assign(this.detailedView.style,e.style);const s=this.calculateStats(),a=this.data.datasets[0];if(e.template&&"function"==typeof e.template)this.detailedView.innerHTML=e.template(i,s,this);else{let t=`\n        <h4>Detailed Analysis</h4>\n        <div class="data-point">\n          <span>Label:</span>\n          <span>${i.label}</span>\n        </div>\n        <div class="data-point">\n          <span>Value:</span>\n          <span>${i.value}</span>\n        </div>\n        ${i.percentage?`\n        <div class="data-point">\n          <span>Percentage:</span>\n          <span>${i.percentage}%</span>\n        </div>\n        `:""}\n        <div class="data-point">\n          <span>Color:</span>\n          <span>\n            <span class="color-indicator" style="background-color: ${i.color};"></span>\n            ${i.color}\n          </span>\n        </div>\n      `;e.customFields&&e.customFields.length>0&&e.customFields.forEach((e=>{const s="function"==typeof e.value?e.value(i,this.hoveredIndex,this):e.value;t+=`\n            <div class="data-point"><span>${e.label}:</span>\n          <span>${s}</span>\n        </div>\n      `})),e.showStats&&(t+=`\n      <div class="section-divider">\n        <strong>Statistics</strong>\n        <div class="data-point">\n          <span>Average:</span>\n          <span>${s.average.toFixed(2)}</span>\n        </div>\n        <div class="data-point">\n          <span>Median:</span>\n          <span>${s.median.toFixed(2)}</span>\n        </div>\n        <div class="data-point">\n          <span>Range:</span>\n          <span>${s.min} - ${s.max}</span>\n        </div>\n        <div class="data-point">\n          <span>Total:</span>\n          <span>${s.total.toFixed(2)}</span>\n        </div>\n        <div class="data-point">\n          <span>Count:</span>\n          <span>${a.data.length}</span>\n        </div>\n      </div>\n    `),e.showRawData&&(t+=`\n      <div class="section-divider">\n        <strong>All Data Points</strong>\n        ${this.data.labels.map(((t,i)=>`\n          <div class="data-point">\n            <span>${t}:</span>\n            <span>${a.data[i]}</span>\n          </div>\n        `)).join("")}\n      </div>\n    `),this.detailedView.innerHTML=t}document.body.appendChild(this.detailedView);let h=t.clientX,n=t.clientY+20;if(e.position&&"auto"!==e.position){const t=this.canvas.getBoundingClientRect();switch(e.position){case"top":h=t.left+t.width/2,n=t.top-20;break;case"bottom":h=t.left+t.width/2,n=t.bottom+20;break;case"left":h=t.left-20,n=t.top+t.height/2;break;case"right":h=t.right+20,n=t.top+t.height/2}}requestAnimationFrame((()=>{const i=this.detailedView.getBoundingClientRect();h+i.width>window.innerWidth-20&&(h=window.innerWidth-i.width-20),h<20&&(h=20),n+i.height>window.innerHeight-20&&(n=t.clientY-i.height-20),n<20&&(n=20),this.detailedView.style.left=h+"px",this.detailedView.style.top=n+"px"})),this.detailedViewClickListener=t=>{this.detailedView.contains(t.target)||t.target===this.canvas||this.hideDetailedView()},setTimeout((()=>{document.addEventListener("mousedown",this.detailedViewClickListener)}),100),this.options.onDetailedView&&this.options.onDetailedView(t,this.hoveredIndex,i,this)}hideDetailedView(){this.detailedView&&this.detailedView.parentNode&&this.detailedView.remove(),this.detailedView=null,this.detailedViewClickListener&&(document.removeEventListener("mousedown",this.detailedViewClickListener),this.detailedViewClickListener=null)}getDataAtPoint(t){if(-1===t||!this.data.datasets[0])return null;const i=this.data.datasets[0];if("gauge"===this.type){const t=i.data[0];return{label:this.data.labels[0]||"Value",value:t,percentage:null,color:this.getGaugeColor(t)}}if("funnel"===this.type){const e=this.getSortedFunnelData().find((i=>i.originalIndex===t));if(e){const t=i.data.reduce(((t,i)=>t+i),0);return{label:e.label,value:e.value,percentage:(e.value/t*100).toFixed(1),color:e.color}}}const e=this.data.labels[t],s=i.data[t];let a=null;if("pie"===this.type||"doughnut"===this.type||"funnel"===this.type){a=(s/i.data.reduce(((t,i)=>t+i),0)*100).toFixed(1)}return{label:e,value:s,percentage:a,color:Array.isArray(i.backgroundColor)?i.backgroundColor[t%i.backgroundColor.length]:i.backgroundColor||"#3b82f6"}}calculateStats(){const t=this.data.datasets[0].data,i=[...t].sort(((t,i)=>t-i)),e=t.reduce(((t,i)=>t+i),0),s=Math.floor(t.length/2),a=t.length%2==0?(i[s-1]+i[s])/2:i[s];return{average:e/t.length,median:a,min:i[0],max:i[t.length-1],total:e}}createGradient(t,i=!1){const e=i?this.ctx.createLinearGradient(this.chartArea.x,0,this.chartArea.x+this.chartArea.width,0):this.ctx.createLinearGradient(0,this.chartArea.y,0,this.chartArea.y+this.chartArea.height),s=this.hexToRgb(t);return s&&(e.addColorStop(0,`rgba(${s.r}, ${s.g}, ${s.b}, 0.8)`),e.addColorStop(1,`rgba(${s.r}, ${s.g}, ${s.b}, 0.4)`)),e}hexToRgb(t){if(!t||!t.startsWith("#"))return null;const i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16),g:parseInt(i[2],16),b:parseInt(i[3],16)}:null}render(){this.cache.clear(),this.animationProgress=0,this.isAnimating=!0,this.frameId&&cancelAnimationFrame(this.frameId),this.animate()}animate(){const t=Date.now(),i=this.options.animation.duration,e=()=>{const s=Date.now()-t;this.animationProgress=Math.min(s/i,1);const a=this.easing(this.animationProgress,this.options.animation.easing);this.draw(a),this.animationProgress<1?this.frameId=requestAnimationFrame(e):(this.isAnimating=!1,this.frameId=null)};this.frameId=requestAnimationFrame(e)}redraw(){this.cache.clear(),this.draw(1)}draw(t){switch(this.clear(),this.calculateLayout(),this.calculateChartArea(),this.options.plugins.title.display&&this.drawTitle(),this.options.plugins.legend.display&&"gauge"!==this.type&&this.drawLegend(),this.type){case"line":this.drawLineChart(t);break;case"bar":this.drawBarChart(t);break;case"horizontalBar":this.drawHorizontalBarChart(t);break;case"pie":this.drawPieChart(t);break;case"doughnut":this.drawDoughnutChart(t);break;case"funnel":this.drawFunnelChart(t);break;case"gauge":this.drawGaugeChart(t);break;case"waterfall":this.drawWaterfallChart(t);break;case"conversionFunnel":this.drawConversionFunnelChart(t)}"line"!==this.type&&"bar"!==this.type&&"horizontalBar"!==this.type||(this.drawAxes(),this.drawGrid()),"waterfall"===this.type&&(this.drawAxes(),this.drawGrid())}calculateLayout(){if(this.titleHeight=0,this.options.plugins.title.display){const t=this.options.plugins.title;this.ctx.save(),this.ctx.font=`${t.font.weight||"bold"} ${t.font.size}px ${t.font.family}`;const i=this.ctx.measureText(t.text);this.titleHeight=i.actualBoundingBoxAscent+i.actualBoundingBoxDescent+t.padding.top+t.padding.bottom+10,this.ctx.restore()}if(this.legendHeight=0,this.legendWidth=0,this.options.plugins.legend.display&&"gauge"!==this.type){const t=this.options.plugins.legend,i="funnel"===this.type?this.getSortedFunnelData().map((t=>t.label)):this.data.labels;this.ctx.save(),this.ctx.font=`${t.labels.font.size}px ${t.labels.font.family}`;const e=i.map((i=>this.ctx.measureText(i).width+t.labels.boxWidth+2*t.labels.padding));"top"===t.position||"bottom"===t.position?(this.legendHeight=Math.max(...e.map((()=>t.labels.boxWidth+t.labels.padding)))+2*t.padding,this.legendWidth=this.width):(this.legendWidth=Math.max(...e)+2*t.padding,this.legendHeight=this.height),this.ctx.restore()}this.axisHeight=0,this.axisWidth=0;const t="horizontalBar"===this.type;if(("line"===this.type||"bar"===this.type||"horizontalBar"===this.type)&&(this.options.scales.x.display||this.options.scales.y.display)){if(this.ctx.save(),this.ctx.font="11px Arial",this.options.scales.y.display){const i=this.options.scales.y.ticks||{},e=t?this.getLongestLabel():this.getLongestYAxisLabel(),s=this.ctx.measureText(e).width;this.axisWidth=Math.max(this.axisWidth,s+(i.padding||10)+15)}if(this.options.scales.x.display){const t=this.options.scales.x.ticks||{},i=this.ctx.measureText("M").actualBoundingBoxAscent+this.ctx.measureText("M").actualBoundingBoxDescent;this.axisHeight=i+(t.padding||10)+15}this.ctx.restore()}}getLongestLabel(){return this.data.labels.reduce(((t,i)=>t.length>i.length?t:i),"")}getLongestYAxisLabel(){const t=this.data.datasets[0].data,i=Math.max(...t,0),e=this.options.scales.y.beginAtZero?0:Math.min(...t,0),s=[];for(let t=0;t<=5;t++){const a=e+t/5*(i-e);s.push(a.toFixed(1))}return s.reduce(((t,i)=>t.length>i.length?t:i))}calculateChartArea(){const t=this.options.layout.padding,i=this.options.plugins.legend;let e=t.top+this.titleHeight,s=t.bottom+this.axisHeight,a=t.left+this.axisWidth,h=t.right;if(i.display&&"gauge"!==this.type)switch(i.position){case"top":e+=this.legendHeight;break;case"bottom":s+=this.legendHeight;break;case"left":a+=this.legendWidth;break;case"right":h+=this.legendWidth}this.chartArea={x:a,y:e,width:Math.max(0,this.width-a-h),height:Math.max(0,this.height-e-s)}}drawLineChart(t){const i=this.data.datasets[0],e=i.data,s=Math.max(...e),a=this.options.scales.y.beginAtZero?0:Math.min(...e),h=s-a||1;this.drawAxisLabels(a,s);const n=[],o=Math.ceil(e.length*t);this.ctx.save(),this.options.elements.line.shadow&&(this.ctx.shadowColor="rgba(0, 0, 0, 0.1)",this.ctx.shadowBlur=8,this.ctx.shadowOffsetY=2);const r=i.borderColor||"#3b82f6";this.ctx.strokeStyle=r,this.ctx.lineWidth=this.options.elements.line.borderWidth,this.ctx.lineJoin="round",this.ctx.lineCap="round",this.ctx.beginPath();for(let t=0;t<o;t++){const i=this.chartArea.x+t/Math.max(e.length-1,1)*this.chartArea.width,s=e[t],o=this.chartArea.y+this.chartArea.height-(s-a)/h*this.chartArea.height;if(n.push({x:i,y:o,index:t}),0===t)this.ctx.moveTo(i,o);else if(this.options.elements.line.tension>0){const e=n[t-1],s=(e.x+i)/2;this.ctx.quadraticCurveTo(s,e.y,i,o)}else this.ctx.lineTo(i,o)}if(this.ctx.stroke(),this.ctx.shadowColor="transparent",this.options.elements.line.fill&&n.length>0){if(this.options.elements.line.gradient){const t=this.ctx.createLinearGradient(0,this.chartArea.y,0,this.chartArea.y+this.chartArea.height),i=this.hexToRgb(r);i&&(t.addColorStop(0,`rgba(${i.r}, ${i.g}, ${i.b}, 0.3)`),t.addColorStop(1,`rgba(${i.r}, ${i.g}, ${i.b}, 0.02)`)),this.ctx.fillStyle=t}else this.ctx.globalAlpha=.15,this.ctx.fillStyle=i.backgroundColor||r;this.ctx.lineTo(n[n.length-1].x,this.chartArea.y+this.chartArea.height),this.ctx.lineTo(n[0].x,this.chartArea.y+this.chartArea.height),this.ctx.closePath(),this.ctx.fill(),this.ctx.globalAlpha=1}n.forEach((t=>{const i=this.hoveredIndex===t.index,e=i?this.options.elements.point.hoverRadius:this.options.elements.point.radius;this.options.elements.point.shadow&&(this.ctx.shadowColor="rgba(0, 0, 0, 0.2)",this.ctx.shadowBlur=i?12:6,this.ctx.shadowOffsetY=i?4:2),this.ctx.fillStyle="#fff",this.ctx.strokeStyle=r,this.ctx.lineWidth=i?3:2,this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.shadowColor="transparent"})),this.ctx.restore()}drawBarChart(t){const i=this.data.datasets[0],e=i.data,s=Math.max(...e,0),a=this.options.scales.y.beginAtZero?0:Math.min(...e,0),h=s-a||1;this.drawAxisLabels(a,s);const n=this.chartArea.width/e.length*.7,o=this.chartArea.width/e.length*.15;this.ctx.save(),e.forEach(((s,r)=>{const l=this.chartArea.x+r/e.length*this.chartArea.width+o,c=Math.abs((s-a)/h)*this.chartArea.height*t,d=s>=0?this.chartArea.y+this.chartArea.height-c:this.chartArea.y+this.chartArea.height,x=this.hoveredIndex===r,g=Array.isArray(i.backgroundColor)?i.backgroundColor[r%i.backgroundColor.length]:i.backgroundColor||"#3b82f6";this.options.elements.bar.shadow&&(this.ctx.shadowColor="rgba(0, 0, 0, 0.15)",this.ctx.shadowBlur=x?16:10,this.ctx.shadowOffsetY=x?6:4);let p=n,u=c,f=l,b=d;if(x&&this.options.elements.bar.hoverScale){const t=this.options.elements.bar.hoverScale;p=n*t,u=c*t,f=l-(p-n)/2,b=s>=0?d-(u-c):d}if(this.options.elements.bar.gradient){const t=this.ctx.createLinearGradient(f,b,f,b+u),i=this.hexToRgb(g);i&&(t.addColorStop(0,`rgba(${i.r}, ${i.g}, ${i.b}, 0.9)`),t.addColorStop(1,`rgba(${i.r}, ${i.g}, ${i.b}, 0.6)`)),this.ctx.fillStyle=t}else this.ctx.fillStyle=x?this.lightenColor(g,15):g;const m=this.options.elements.bar.borderRadius;this.roundRect(this.ctx,f,b,p,u,m),this.ctx.fill(),this.options.elements.bar.borderWidth>0&&(this.ctx.strokeStyle=i.borderColor||"#fff",this.ctx.lineWidth=this.options.elements.bar.borderWidth,this.ctx.stroke()),this.ctx.shadowColor="transparent"})),this.ctx.restore()}drawHorizontalBarChart(t){const i=this.data.datasets[0],e=i.data,s=Math.max(...e,0),a=this.options.scales.y.beginAtZero?0:Math.min(...e,0),h=s-a||1;this.drawHorizontalAxisLabels(a,s);const n=this.chartArea.height/e.length*.7,o=this.chartArea.height/e.length*.15;this.ctx.save(),e.forEach(((s,r)=>{const l=this.chartArea.y+r/e.length*this.chartArea.height+o,c=Math.abs((s-a)/h)*this.chartArea.width*t,d=s>=0?this.chartArea.x:this.chartArea.x-c,x=this.hoveredIndex===r,g=Array.isArray(i.backgroundColor)?i.backgroundColor[r%i.backgroundColor.length]:i.backgroundColor||"#3b82f6";this.options.elements.bar.shadow&&(this.ctx.shadowColor="rgba(0, 0, 0, 0.15)",this.ctx.shadowBlur=x?16:10,this.ctx.shadowOffsetX=x?6:4);let p=c,u=n,f=d,b=l;if(x&&this.options.elements.bar.hoverScale){const t=this.options.elements.bar.hoverScale;p=c*t,u=n*t,b=l-(u-n)/2,f=s>=0?d:d-(p-c)}if(this.options.elements.bar.gradient){const t=this.ctx.createLinearGradient(f,b,f+p,b),i=this.hexToRgb(g);i&&(t.addColorStop(0,`rgba(${i.r}, ${i.g}, ${i.b}, 0.6)`),t.addColorStop(1,`rgba(${i.r}, ${i.g}, ${i.b}, 0.9)`)),this.ctx.fillStyle=t}else this.ctx.fillStyle=x?this.lightenColor(g,15):g;const m=this.options.elements.bar.borderRadius;this.roundRect(this.ctx,f,b,p,u,m),this.ctx.fill(),this.options.elements.bar.borderWidth>0&&(this.ctx.strokeStyle=i.borderColor||"#fff",this.ctx.lineWidth=this.options.elements.bar.borderWidth,this.ctx.stroke()),this.ctx.shadowColor="transparent"})),this.ctx.restore()}drawPieChart(t){this.drawCircularChart(t,0)}drawDoughnutChart(t){const i=.5*(Math.min(this.width,this.height)/2-60);this.drawCircularChart(t,i)}drawCircularChart(t,i){const e=this.data.datasets[0],s=e.data,a=s.reduce(((t,i)=>t+i),0),h=this.width/2,n=this.chartArea.y+this.chartArea.height/2,o=Math.min(this.chartArea.width,this.chartArea.height)/2-20;let r=-Math.PI/2;this.ctx.save(),s.forEach(((s,l)=>{const c=s/a*Math.PI*2*t,d=this.hoveredIndex===l,x=d?this.options.elements.arc.hoverOffset:0,g=r+c/2,p=Math.cos(g)*x,u=Math.sin(g)*x,f=Array.isArray(e.backgroundColor)?e.backgroundColor[l%e.backgroundColor.length]:e.backgroundColor||"#3b82f6";this.options.elements.arc.shadow&&(this.ctx.shadowColor="rgba(0, 0, 0, 0.2)",this.ctx.shadowBlur=d?20:12,this.ctx.shadowOffsetY=d?6:3),this.ctx.fillStyle=d?this.lightenColor(f,10):f,this.ctx.beginPath(),i>0?(this.ctx.arc(h+p,n+u,o,r,r+c),this.ctx.arc(h+p,n+u,i,r+c,r,!0)):(this.ctx.moveTo(h+p,n+u),this.ctx.arc(h+p,n+u,o,r,r+c)),this.ctx.closePath(),this.ctx.fill(),this.options.elements.arc.borderWidth>0&&(this.ctx.shadowColor="transparent",this.ctx.strokeStyle=this.options.elements.arc.borderColor,this.ctx.lineWidth=this.options.elements.arc.borderWidth,this.ctx.stroke()),r+=c})),this.ctx.shadowColor="transparent",this.ctx.restore()}getSortedFunnelData(){const t=this.data.datasets[0],i=t.data.map(((i,e)=>({value:i,label:this.data.labels[e],originalIndex:e,color:Array.isArray(t.backgroundColor)?t.backgroundColor[e%t.backgroundColor.length]:t.backgroundColor||"#3b82f6"})));return"desc"===this.options.funnel.sort?i.sort(((t,i)=>i.value-t.value)):"asc"===this.options.funnel.sort?i.sort(((t,i)=>t.value-i.value)):i}getFunnelSegmentWidth(t,i){if(t>=i.length)return this.chartArea.width*this.options.funnel.width*.3;if(0===t)return this.chartArea.width*this.options.funnel.width;const e=Math.max(...i.map((t=>t.value))),s=i[t].value/e;return this.chartArea.width*this.options.funnel.width*(.3+.7*s)}drawFunnelChart(t){const i=this.getSortedFunnelData(),e=this.chartArea.height/i.length,s=e*this.options.funnel.gap;this.ctx.save(),i.forEach(((a,h)=>{const n=Math.max(0,Math.min(1,(t-h/i.length)*i.length));if(n<=0)return;const o=this.getFunnelSegmentWidth(h,i)*n,r=this.getFunnelSegmentWidth(h+1,i)*n,l=this.chartArea.y+h*e,c=this.chartArea.x+(this.chartArea.width-o)/2,d=this.chartArea.x+(this.chartArea.width-r)/2,x=this.hoveredIndex===a.originalIndex;this.options.elements.bar.shadow&&(this.ctx.shadowColor="rgba(0, 0, 0, 0.15)",this.ctx.shadowBlur=x?20:12,this.ctx.shadowOffsetY=x?6:3),this.ctx.fillStyle=x?this.lightenColor(a.color,15):a.color,this.ctx.beginPath(),this.ctx.moveTo(c,l),this.ctx.lineTo(c+o,l),this.ctx.lineTo(d+r,l+e-s),this.ctx.lineTo(d,l+e-s),this.ctx.closePath(),this.ctx.fill(),this.options.elements.bar.borderWidth>0&&(this.ctx.shadowColor="transparent",this.ctx.strokeStyle="#fff",this.ctx.lineWidth=2,this.ctx.stroke()),this.ctx.shadowColor="rgba(0, 0, 0, 0.3)",this.ctx.shadowBlur=4,this.ctx.fillStyle="#fff",this.ctx.font="bold 14px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const g=l+(e-s)/2;this.ctx.fillText(a.label,this.chartArea.x+this.chartArea.width/2,g-10),this.ctx.font="13px Arial",this.ctx.fillText(a.value.toFixed(0),this.chartArea.x+this.chartArea.width/2,g+10),this.ctx.shadowColor="transparent"})),this.ctx.restore()}getGaugeColor(t){const i=this.options.gauge.ranges;for(let e of i)if(t>=e.min&&t<=e.max)return e.color;return i[i.length-1].color}drawGaugeChart(t){const i=this.data.datasets[0].data[0],e=100,s=this.width/2,a=this.chartArea.y+.65*this.chartArea.height,h=.75*(Math.min(this.chartArea.width,this.chartArea.height)/2),n=h*this.options.gauge.thickness,o=h-n,r=this.options.gauge.startAngle*Math.PI/180,l=this.options.gauge.endAngle*Math.PI/180,c=l-r;this.ctx.save(),this.ctx.lineCap="round",this.ctx.shadowColor="rgba(0, 0, 0, 0.1)",this.ctx.shadowBlur=10,this.ctx.shadowOffsetY=3;const d=this.options.gauge.ranges;d.forEach(((t,i)=>{const h=r+t.min/e*c+(i>0?.015:0),l=r+t.max/e*c-.015;this.ctx.lineWidth=n,this.ctx.strokeStyle=t.color,this.ctx.beginPath(),this.ctx.arc(s,a,o+n/2,h,l),this.ctx.stroke()})),this.ctx.shadowColor="transparent";const x=r+i/e*c*t,g=o-10;this.ctx.shadowColor="rgba(0, 0, 0, 0.3)",this.ctx.shadowBlur=8,this.ctx.shadowOffsetY=3,this.ctx.fillStyle="#2c3e50",this.ctx.beginPath(),this.ctx.moveTo(s+6*Math.cos(x-Math.PI/2)/2,a+6*Math.sin(x-Math.PI/2)/2),this.ctx.lineTo(s+Math.cos(x)*g,a+Math.sin(x)*g),this.ctx.lineTo(s+6*Math.cos(x+Math.PI/2)/2,a+6*Math.sin(x+Math.PI/2)/2),this.ctx.closePath(),this.ctx.fill();if(this.ctx.fillStyle="#2c3e50",this.ctx.beginPath(),this.ctx.arc(s,a,14,0,2*Math.PI),this.ctx.fill(),this.ctx.shadowColor="transparent",this.options.gauge.showValue){const e=this.options.gauge.valueFormat(i*t),h=this.data.labels[0]||"",n=this.getGaugeColor(i);this.ctx.fillStyle=n,this.ctx.font="bold 52px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText(e,s,a-15),this.ctx.font="18px Arial",this.ctx.fillStyle="#999",this.ctx.fillText(h,s,a+30)}this.ctx.font="15px Arial",this.ctx.fillStyle="#888",this.ctx.textAlign="center",this.ctx.textBaseline="middle";const p=s+Math.cos(r)*(h+n/2+18),u=a+Math.sin(r)*(h+n/2+18);this.ctx.fillText((0).toString(),p,u);const f=s+Math.cos(l)*(h+n/2+18),b=a+Math.sin(l)*(h+n/2+18);this.ctx.fillText(e.toString(),f,b),this.ctx.restore()}drawWaterfallChart(t){const i=this.data.datasets[0],e=i.data;let s=0;const a=e.map(((t,e)=>{const a=s,h=i.isTotal&&i.isTotal[e];return h?s=t:s+=t,{value:t,start:a,end:s,isTotal:h}})),h=a.flatMap((t=>[t.start,t.end])),n=Math.max(...h,0),o=Math.min(...h,0),r=n-o||1;this.drawAxisLabels(o,n);const l=this.chartArea.width/e.length*.6,c=this.chartArea.width/e.length*.2;this.ctx.save(),a.forEach(((s,h)=>{const n=Math.max(0,Math.min(1,(t-h/e.length)*e.length));if(n<=0)return;const d=this.chartArea.x+h/e.length*this.chartArea.width+c,x=this.hoveredIndex===h,g=this.chartArea.y+this.chartArea.height-(s.start-o)/r*this.chartArea.height,p=this.chartArea.y+this.chartArea.height-(s.end-o)/r*this.chartArea.height,u=Math.abs(g-p)*n,f=s.value>=0?p:g;let b;b=s.isTotal?this.options.waterfall.totalColor:s.value>=0?this.options.waterfall.positiveColor:this.options.waterfall.negativeColor,this.options.elements.bar.shadow&&(this.ctx.shadowColor="rgba(0, 0, 0, 0.15)",this.ctx.shadowBlur=x?16:10,this.ctx.shadowOffsetY=x?6:4);let m=l,w=u,A=d,y=f;if(x&&this.options.elements.bar.hoverScale){const t=this.options.elements.bar.hoverScale;m=l*t,w=u*t,A=d-(m-l)/2}if(this.options.elements.bar.gradient){const t=this.ctx.createLinearGradient(A,y,A,y+w),i=this.hexToRgb(b);i&&(t.addColorStop(0,`rgba(${i.r}, ${i.g}, ${i.b}, 0.9)`),t.addColorStop(1,`rgba(${i.r}, ${i.g}, ${i.b}, 0.6)`)),this.ctx.fillStyle=t}else this.ctx.fillStyle=x?this.lightenColor(b,15):b;const v=this.options.elements.bar.borderRadius;if(this.roundRect(this.ctx,A,y,m,w,v),this.ctx.fill(),this.options.elements.bar.borderWidth>0&&(this.ctx.strokeStyle=i.borderColor||"#fff",this.ctx.lineWidth=this.options.elements.bar.borderWidth,this.ctx.stroke()),this.ctx.shadowColor="transparent",h<a.length-1&&this.options.waterfall.connectorLine&&!s.isTotal){const t=a[h+1],i=this.chartArea.x+(h+1)/e.length*this.chartArea.width+c,s=this.chartArea.y+this.chartArea.height-(t.start-o)/r*this.chartArea.height;this.ctx.strokeStyle=this.options.waterfall.connectorColor,this.ctx.lineWidth=2,"dashed"===this.options.waterfall.connectorStyle&&this.ctx.setLineDash([5,3]),this.ctx.beginPath(),this.ctx.moveTo(d+l,p),this.ctx.lineTo(i,s),this.ctx.stroke(),this.ctx.setLineDash([])}if(this.options.waterfall.showValues){this.ctx.fillStyle="#666",this.ctx.font="bold 11px Arial",this.ctx.textAlign="center",this.ctx.textBaseline="bottom";const t=f-5;this.ctx.fillText(s.value>0?"+"+s.value:s.value,d+l/2,t)}})),this.ctx.restore()}drawConversionFunnelChart(t){const i=this.data.datasets[0].data,e=this.data.labels,s=this.chartArea.width/i.length*.25,a=this.chartArea.width/i.length;this.ctx.save();const h=Math.max(...i)-0||1;this.ctx.globalAlpha=.15;for(let e=0;e<i.length-1;e++){if(Math.max(0,Math.min(1,(t-e/i.length)*i.length))<=0)continue;const n=this.chartArea.x+e*a+a/2,o=i[e]/h*this.chartArea.height*t,r=(this.chartArea.y,this.chartArea.height,this.chartArea.x+(e+1)*a+a/2),l=i[e+1]/h*this.chartArea.height*t,c=(this.chartArea.y,this.chartArea.height,e===i.length-2?"#10b981":"#6BA3F9");this.ctx.fillStyle=c,this.ctx.beginPath(),this.ctx.moveTo(n-s/2,this.chartArea.y+this.chartArea.height),this.ctx.lineTo(n+s/2,this.chartArea.y+this.chartArea.height),this.ctx.lineTo(r+s/2,this.chartArea.y+this.chartArea.height),this.ctx.lineTo(r-s/2,this.chartArea.y+this.chartArea.height),this.ctx.closePath(),this.ctx.fill()}if(this.ctx.globalAlpha=1,i.forEach(((n,o)=>{const r=Math.max(0,Math.min(1,(t-o/i.length)*i.length));if(r<=0)return;const l=this.chartArea.x+o*a+a/2-s/2,c=n/h*this.chartArea.height*r,d=this.chartArea.y+this.chartArea.height-c,x=this.hoveredIndex===o,g=o===i.length-1?"#10b981":"#6BA3F9";this.options.elements.bar.shadow&&(this.ctx.shadowColor="rgba(0, 0, 0, 0.15)",this.ctx.shadowBlur=x?16:10,this.ctx.shadowOffsetY=x?6:4),this.ctx.fillStyle=x?this.lightenColor(g,10):g;const p=this.options.elements.bar.borderRadius||6;this.roundRect(this.ctx,l,d,s,c,p),this.ctx.fill(),this.ctx.shadowColor="transparent",this.ctx.fillStyle="#333",this.ctx.font=`bold ${this.options.conversionFunnel.valueFontSize||18}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="bottom",this.ctx.fillText(n.toFixed(0),l+s/2,d-8),this.ctx.fillStyle="#666",this.ctx.font=`${this.options.conversionFunnel.labelFontSize||12}px Arial`,this.ctx.textBaseline="top",this.ctx.fillText(e[o],l+s/2,this.chartArea.y+this.chartArea.height+12)})),this.options.conversionFunnel.showConversionRates)for(let t=0;t<i.length-1;t++){const e=(i[t+1]/i[t]*100).toFixed(1),s=(this.chartArea.x+t*a+a/2+(this.chartArea.x+(t+1)*a+a/2))/2,h=this.chartArea.y+this.chartArea.height-.5*this.chartArea.height,n=this.options.conversionFunnel.conversionRateFont||{};this.ctx.fillStyle=n.color||"#666",this.ctx.font=`${n.weight||"normal"} ${n.size||13}px Arial`,this.ctx.textAlign="center",this.ctx.textBaseline="middle";const o=e+"%",r=this.ctx.measureText(o).width,l=8;this.ctx.fillStyle="rgba(255, 255, 255, 0.95)",this.ctx.shadowColor="rgba(0, 0, 0, 0.1)",this.ctx.shadowBlur=6,this.ctx.shadowOffsetY=2,this.roundRect(this.ctx,s-r/2-l,h-12,r+2*l,24,6),this.ctx.fill(),this.ctx.shadowColor="transparent",this.ctx.fillStyle=n.color||"#666",this.ctx.fillText(o,s,h)}if(i.length>0){const t=(i[i.length-1]/i[0]*100).toFixed(0);this.ctx.fillStyle="#10b981",this.ctx.font="bold 48px Arial",this.ctx.textAlign="right",this.ctx.textBaseline="top",this.ctx.fillText(t+"%",this.chartArea.x+this.chartArea.width+150,this.chartArea.y+50),this.ctx.fillStyle="#999",this.ctx.font="14px Arial",this.ctx.fillText("Conversion to",this.chartArea.x+this.chartArea.width+150,this.chartArea.y+110),this.ctx.fillText("Closed-Committed",this.chartArea.x+this.chartArea.width+150,this.chartArea.y+130)}this.ctx.restore()}getConversionFunnelElement(t,i){if(!this.chartArea)return-1;const e=this.data.datasets[0].data,s=this.chartArea.width/e.length*.25,a=this.chartArea.width/e.length,h=Math.max(...e)||1;for(let n=0;n<e.length;n++){const o=this.chartArea.x+n*a+a/2-s/2,r=e[n]/h*this.chartArea.height,l=this.chartArea.y+this.chartArea.height-r;if(t>=o&&t<=o+s&&i>=l&&i<=l+r)return n}return-1}getConversionFunnelSegmentWidth(t,i){if(t>=i.length)return this.chartArea.width*this.options.conversionFunnel.width*.4;if(0===t)return this.chartArea.width*this.options.conversionFunnel.width;const e=i[0].value,s=i[t].value/e;return this.chartArea.width*this.options.conversionFunnel.width*s}drawTitle(){const t=this.options.plugins.title;this.ctx.save(),this.ctx.font=`${t.font.weight||"bold"} ${t.font.size}px ${t.font.family}`,this.ctx.fillStyle=t.color,this.ctx.textAlign=t.align||"center",this.ctx.textBaseline="top";const i="start"===t.align?this.options.layout.padding.left:"end"===t.align?this.width-this.options.layout.padding.right:this.width/2;this.ctx.fillText(t.text,i,this.options.layout.padding.top+t.padding.top),this.ctx.restore()}drawLegend(){const t=this.options.plugins.legend,i=this.data.datasets[0],e="funnel"===this.type?this.getSortedFunnelData().map((t=>t.label)):this.data.labels;this.ctx.save(),this.ctx.font=`${t.labels.font.weight||"500"} ${t.labels.font.size}px ${t.labels.font.family}`,this.ctx.textBaseline="middle";const s=e.map((i=>this.ctx.measureText(i).width+t.labels.boxWidth+2*t.labels.padding)),a=s.reduce(((t,i)=>t+i),0),h=t.labels.boxWidth+t.labels.padding;let n,o;switch(t.position){case"top":n="start"===t.align?this.options.layout.padding.left:"end"===t.align?this.width-a-this.options.layout.padding.right:(this.width-a)/2,o=this.options.layout.padding.top+this.titleHeight+t.padding;break;case"bottom":n="start"===t.align?this.options.layout.padding.left:"end"===t.align?this.width-a-this.options.layout.padding.right:(this.width-a)/2,o=this.height-this.options.layout.padding.bottom-this.legendHeight+t.padding;break;case"left":n=this.options.layout.padding.left+t.padding,o=this.chartArea.y+(this.chartArea.height-e.length*h)/2;break;case"right":n=this.width-this.options.layout.padding.right-this.legendWidth+t.padding,o=this.chartArea.y+(this.chartArea.height-e.length*h)/2}let r=n,l=o;e.forEach(((e,a)=>{const n=Array.isArray(i.backgroundColor)?i.backgroundColor[a%i.backgroundColor.length]:i.backgroundColor||"#3b82f6";this.ctx.shadowColor="rgba(0, 0, 0, 0.1)",this.ctx.shadowBlur=4,this.ctx.shadowOffsetY=2,this.ctx.fillStyle=n,t.labels.usePointStyle?(this.ctx.beginPath(),this.ctx.arc(r+t.labels.boxWidth/2,l,t.labels.boxWidth/2,0,2*Math.PI),this.ctx.fill()):(this.roundRect(this.ctx,r,l-t.labels.boxWidth/2,t.labels.boxWidth,t.labels.boxWidth,3),this.ctx.fill()),this.ctx.shadowColor="transparent",this.ctx.fillStyle=t.labels.color,this.ctx.textAlign="left",this.ctx.fillText(e,r+t.labels.boxWidth+t.labels.padding,l),"left"===t.position||"right"===t.position?l+=h:r+=s[a]})),this.ctx.restore()}drawAxes(){(this.options.scales.x.display||this.options.scales.y.display)&&(this.ctx.save(),this.ctx.strokeStyle="#ccc",this.ctx.lineWidth=1,this.ctx.beginPath(),"horizontalBar"===this.type?(this.options.scales.x.display&&(this.ctx.moveTo(this.chartArea.x,this.chartArea.y),this.ctx.lineTo(this.chartArea.x,this.chartArea.y+this.chartArea.height)),this.options.scales.y.display&&(this.ctx.moveTo(this.chartArea.x,this.chartArea.y+this.chartArea.height),this.ctx.lineTo(this.chartArea.x+this.chartArea.width,this.chartArea.y+this.chartArea.height))):(this.options.scales.y.display&&(this.ctx.moveTo(this.chartArea.x,this.chartArea.y),this.ctx.lineTo(this.chartArea.x,this.chartArea.y+this.chartArea.height)),this.options.scales.x.display&&(this.ctx.moveTo(this.chartArea.x,this.chartArea.y+this.chartArea.height),this.ctx.lineTo(this.chartArea.x+this.chartArea.width,this.chartArea.y+this.chartArea.height))),this.ctx.stroke(),this.ctx.restore())}drawGrid(){const t=this.options.scales.x.grid,i=this.options.scales.y.grid;if(t.display||i.display){if(this.ctx.save(),this.ctx.lineWidth=1,"horizontalBar"===this.type){if(t.display){this.ctx.strokeStyle=t.color;for(let t=0;t<=5;t++){const i=this.chartArea.x+t/5*this.chartArea.width;this.ctx.beginPath(),this.ctx.moveTo(i,this.chartArea.y),this.ctx.lineTo(i,this.chartArea.y+this.chartArea.height),this.ctx.stroke()}}if(i.display){this.ctx.strokeStyle=i.color;const t=this.data.labels.length;for(let i=0;i<t;i++){const e=this.chartArea.y+i/Math.max(t-1,1)*this.chartArea.height;this.ctx.beginPath(),this.ctx.moveTo(this.chartArea.x,e),this.ctx.lineTo(this.chartArea.x+this.chartArea.width,e),this.ctx.stroke()}}}else{if(i.display){this.ctx.strokeStyle=i.color;for(let t=0;t<=5;t++){const i=this.chartArea.y+t/5*this.chartArea.height;this.ctx.beginPath(),this.ctx.moveTo(this.chartArea.x,i),this.ctx.lineTo(this.chartArea.x+this.chartArea.width,i),this.ctx.stroke()}}if(t.display){this.ctx.strokeStyle=t.color;const i=this.data.labels.length;for(let t=0;t<i;t++){const e=this.chartArea.x+t/Math.max(i-1,1)*this.chartArea.width;this.ctx.beginPath(),this.ctx.moveTo(e,this.chartArea.y),this.ctx.lineTo(e,this.chartArea.y+this.chartArea.height),this.ctx.stroke()}}}this.ctx.restore()}}drawAxisLabels(t,i){if(this.options.scales.x.display||this.options.scales.y.display){if(this.ctx.save(),this.options.scales.y.display){const e=this.options.scales.y.ticks||{};this.ctx.font=`${e.font?.size||11}px Arial`,this.ctx.fillStyle=e.color||"#666",this.ctx.textAlign="right",this.ctx.textBaseline="middle";for(let e=0;e<=5;e++){const s=t+e/5*(i-t),a=this.chartArea.y+this.chartArea.height-e/5*this.chartArea.height;this.ctx.fillText(s.toFixed(1),this.chartArea.x-10,a)}}if(this.options.scales.x.display){const t=this.options.scales.x.ticks||{};this.ctx.font=`${t.font?.size||11}px Arial`,this.ctx.fillStyle=t.color||"#666",this.ctx.textAlign="center",this.ctx.textBaseline="top",this.data.labels.forEach(((t,i)=>{const e=this.chartArea.x+i/Math.max(this.data.labels.length-1,1)*this.chartArea.width;this.ctx.fillText(t,e,this.chartArea.y+this.chartArea.height+8)}))}this.ctx.restore()}}drawHorizontalAxisLabels(t,i){if(this.options.scales.x.display||this.options.scales.y.display){if(this.ctx.save(),this.options.scales.x.display){const e=this.options.scales.x.ticks||{};this.ctx.font=`${e.font?.size||11}px Arial`,this.ctx.fillStyle=e.color||"#666",this.ctx.textAlign="center",this.ctx.textBaseline="top";for(let e=0;e<=5;e++){const s=t+e/5*(i-t),a=this.chartArea.x+e/5*this.chartArea.width;this.ctx.fillText(s.toFixed(1),a,this.chartArea.y+this.chartArea.height+8)}}if(this.options.scales.y.display){const t=this.options.scales.y.ticks||{};this.ctx.font=`${t.font?.size||11}px Arial`,this.ctx.fillStyle=t.color||"#666",this.ctx.textAlign="right",this.ctx.textBaseline="middle",this.data.labels.forEach(((t,i)=>{const e=this.chartArea.y+i/Math.max(this.data.labels.length-1,1)*this.chartArea.height;this.ctx.fillText(t,this.chartArea.x-10,e)}))}this.ctx.restore()}}clear(){this.ctx.clearRect(0,0,this.width,this.height),this.ctx.fillStyle=this.backgroundColor,this.ctx.fillRect(0,0,this.width,this.height)}setBackgroundColor(t){this.backgroundColor=t,this.redraw()}roundRect(t,i,e,s,a,h){s<0||a<0||(h=Math.min(h,Math.abs(s)/2,Math.abs(a)/2),t.beginPath(),t.moveTo(i+h,e),t.lineTo(i+s-h,e),t.quadraticCurveTo(i+s,e,i+s,e+h),t.lineTo(i+s,e+a-h),t.quadraticCurveTo(i+s,e+a,i+s-h,e+a),t.lineTo(i+h,e+a),t.quadraticCurveTo(i,e+a,i,e+a-h),t.lineTo(i,e+h),t.quadraticCurveTo(i,e,i+h,e),t.closePath())}lightenColor(t,i){if(!t||"transparent"===t)return"#3b82f6";let e,s,a;if(t.startsWith("#")){const i=t.replace("#","");e=parseInt(i.substr(0,2),16),s=parseInt(i.substr(2,2),16),a=parseInt(i.substr(4,2),16)}else{if(!t.startsWith("rgb"))return t;{const i=t.match(/(\d+),\s*(\d+),\s*(\d+)/);if(!i)return t;e=parseInt(i[1]),s=parseInt(i[2]),a=parseInt(i[3])}}const h=Math.round(2.55*i);return e=Math.min(255,e+h),s=Math.min(255,s+h),a=Math.min(255,a+h),`rgb(${e}, ${s}, ${a})`}easing(t,i){const e={linear:t=>t,easeInQuad:t=>t*t,easeOutQuad:t=>t*(2-t),easeInOutQuad:t=>t<.5?2*t*t:(4-2*t)*t-1,easeOutQuart:t=>1-Math.pow(1-t,4),easeInOutCubic:t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,easeOutElastic:t=>Math.pow(2,-10*t)*Math.sin((t-.075)*(2*Math.PI)/.3)+1,easeOutBack:t=>{const i=1.70158;return 1+2.70158*Math.pow(t-1,3)+i*Math.pow(t-1,2)}};return e[i]?e[i](t):e.easeOutQuart(t)}update(t){this.cache.clear(),t.data&&(this.data=t.data),t.options&&(this.options=this.mergeOptions(t.options)),t.type&&(this.type=t.type),t.backgroundColor&&(this.backgroundColor=t.backgroundColor),this.render()}destroy(){this.removeEventListeners(),this.hideTooltip(),this.hideDetailedView(),this.clear(),this.frameId&&(cancelAnimationFrame(this.frameId),this.frameId=null),this.cache.clear()}removeEventListeners(){this.boundHandlers&&(this.canvas.removeEventListener("mousemove",this.boundHandlers.mousemove),this.canvas.removeEventListener("mouseleave",this.boundHandlers.mouseleave),this.canvas.removeEventListener("click",this.boundHandlers.click),this.canvas.removeEventListener("dblclick",this.boundHandlers.dblclick),this.canvas.removeEventListener("touchstart",this.boundHandlers.touchstart),this.canvas.removeEventListener("touchmove",this.boundHandlers.touchmove),this.canvas.removeEventListener("touchend",this.boundHandlers.touchend),window.removeEventListener("resize",this.boundHandlers.resize),this.detailedViewClickListener&&(document.removeEventListener("mousedown",this.detailedViewClickListener),this.detailedViewClickListener=null),this.boundHandlers={})}}"undefined"!=typeof module&&module.exports&&(module.exports=ChartMaster),"undefined"!=typeof window&&(window.ChartMaster=ChartMaster);